
{% load static %}
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="stylesheet" href="{% static 'django_project/css/styles.css' %}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet'>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>	


    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <!--<link rel="stylesheet" href="style.css">-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.1/dist/chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{% static 'django_project/css/alphavantage.css' %}">
    <title>Cotações</title>
</head>

<body>
<section class="dashboard" >
      <div class="row">
        <div class="sidebar col-1">
          <a href="/dashboard" style=" padding-bottom: 1rem;"><img class="card-img-top offset-3" style="max-width: 2rem;"  src="{% static 'django_project/img/dashboard/icon0.png' %}" alt="Card image cap"> </a>
          <a href="/dashboard-analises" style="padding-bottom: 1rem;"><img class="card-img-top offset-3" style="max-width: 1.5rem; "  src="{% static 'django_project/img/dashboard/icon1.png' %}" alt="Card image cap"> </a>
          <a href="/stock_data" style="padding-bottom: 1rem;"><i class="fa fa-area-chart card-img-top offset-3" style="max-width: 1.5rem; text-decoration:none" aria-hidden="true"></i></a>
          <a href="/dashboard-noticias" style="padding-bottom: 1rem"><img class="card-img-top offset-3" style="max-width: 1.5rem; "  src="{% static 'django_project/img/dashboard/icon2.png' %}" alt="Card image cap"> </a>
          <a href="/dashboard-assinaturas" style="padding-bottom: 1rem"><img class="card-img-top offset-3" style="max-width: 1.5rem; "  src="{% static 'django_project/img/dashboard/icon3.png' %}" alt="Card image cap"> </a>
          <a href="/dashboard-especialista" style="padding-bottom: 1rem"><img class="card-img-top offset-3" style="max-width: 1.5rem; "  src="{% static 'django_project/img/dashboard/icon4.png' %}" alt="Card image cap"> </a>
          <a href="/dashboard-videos" style="padding-bottom: 1rem"><img class="card-img-top offset-3" style="max-width: 1.5rem; "  src="{% static 'django_project/img/dashboard/icon5.png' %}" alt="Card image cap"> </a>
          <a href="/dashboard-perfil" style="padding-bottom: 1rem"><img class="card-img-top offset-3" style="max-width: 1.5rem; "  src="{% static 'django_project/img/dashboard/icon6.png' %}" alt="Card image cap"> </a>
          <a href="{% url 'logout' %}" style="padding-bottom: 18rem"><img class="card-img-top offset-3" style="max-width: 1.5rem; "  src="{% static 'django_project/img/dashboard/icon7.png' %}" alt="Card image cap"> </a>
          <a href="#contact"><img class="card-img-top offset-3" style="max-width: 1.5rem;"  src="{% static 'django_project/img/dashboard/icon8.png' %}" alt="Card image cap"> </a>
        </div>
      
        <div class="col-10">
            <!--CARD Cotação-->
            <div class="row" style="position:flex;justify-content:center;align-items:center">

                <div class="card text-white bg-danger" style="max-width: 20%;">
                    <div class="card-header">Header</div>
                    <div class="card-body">
                        <h5 class="card-title">Danger card title</h5>
                        <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                </div>

                <div class="card text-white bg-danger" style="max-width: 20%; margin-left:5%">
                    <div class="card-header">Header</div>
                    <div class="card-body">
                        <h5 class="card-title">Danger card title</h5>
                        <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                </div>

                <div class="card text-white bg-danger" style="max-width: 20%; margin-left:5%">
                    <div class="card-header">Header</div>
                    <div class="card-body">
                        <h5 class="card-title">Danger card title</h5>
                        <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                    </div>
                </div>

            </div>
            <!--END CARD Cotação-->

            <!--CHART 1-->
            <div class="card-body" style="position:flex;justify-content:center;align-items:center">
                <div id="search">
                    
                        <input class=" input-width" type="text" id="ticker-input">
                        <button type="submit" class="btn btn-danger" id="submit-btn">Pesquisar</button>
                    
                </div>

                <div id="graph-area" style=" width:100%;
                    background: linear-gradient(45deg, red, black 65%);
                    position:flex;justify-content:center;align-items:center">
                    <canvas id="myChart"></canvas>
                    
                </div>
                
            
            <!--END CHART 1-->

            <!--CHART 2-->
            <div id="search" class="mt-3">
			<form class="d-flex" action="" method="POST" id="myForm">
			  <input class="form-control me-2 input-width" type="search" id="txtSymbol" placeholder="PETR4.SA" aria-label="Search">
			  <button class="btn btn-danger" type="button" onclick="validar()">Pesquisar</button>
			</form>		
		    </div>
		
		<!-- Informações sobre erros -->
		<div id="error">
			Deu erro!
		</div>
		
		<!-- Exibição dos dados -->
		
		<div id="wrapper">
			<div id="table" class="table-div">
				<table id="series-table" class="table">
				  <thead>
					<tr class="table-primary">			  
					  <th scope="col">Data</th>
					  <th scope="col">Abertura</th>
					  <th scope="col">Fechamento</th>
					</tr>
				  </thead>
				  <tbody></tbody>
				</table>	
			</div>
			
			<div id="chart-column" class="column-chart"></div>
		</div>
		
		<div class="col-md-12">
		<div id="chart-line" class="line-chart"></div>
		</div>		
	</div>
                    
                </div>

            <!--END CHART 2-->
            </div>
                
            

        

      </div>
      </section>
      <link rel="stylesheet" href="{% static 'django_project/js/alphavantage.js' %}">			
	<script type="text/javascript" src="{% static 'django_project/js/bootstrap/dist/js/bootstrap.min.js' %}"></script>



<script>

    $(document).ready(function(){
        
        // Right after the page is loaded, we get the stock data (default to AAPL) from the Django backend (the 'get_stock_data' function) for plotting
        $.ajax({
              type: "POST",
              url: "/get_stock_data/",
              data: {
                 'ticker': 'AAPL',
              },
              success: function (res, status) {
                // AAPL's stock price and SMA data is now in the "res" object
                var tickerDisplay = res['prices']['Meta Data']['2. Symbol'];
                var graphTitle = tickerDisplay + ' (data for the trailing 500 trading days)'

                var priceSeries = res['prices']['Time Series (Daily)'];
                var daily_adjusted_close = [];
                var dates = [];

                price_data_parse = function(){
                    for (let key in priceSeries) {
                        daily_adjusted_close.push(Number(priceSeries[key]['5. adjusted close']));
                        dates.push(String(key));
                    }

                };
                price_data_parse();

                var smaSeries = res['sma']['Technical Analysis: SMA'];
                var sma_data = [];

                sma_data_parse = function(){
                    for (let key in smaSeries) {
                        sma_data.push(Number(smaSeries[key]['SMA']));
                    }

                };
                sma_data_parse();


                // only keep the latest 500 data points (i.e., data for the latest 500 trading days) for the three lists below
                daily_adjusted_close.reverse().slice(24);
                sma_data.reverse().slice(24);
                dates.reverse().slice(24);

                //instruct Chart.js to plot the graph, with "dates" as the x-axis labels and "daily_adjusted_close" and "sma_data" as the y-axis values
                var ctx = document.getElementById('myChart').getContext('2d');
                var myChart = new Chart(ctx, {
                    
                type: 'line',
                    data: {
                        labels: dates.slice(-24),
                        datasets: [
                            {
                                label: 'Daily Adjusted Close',
                                data: daily_adjusted_close.slice(-24),
                                backgroundColor: [
                                    'green',
                                ],
                                borderColor: [
                                    'green',
                                ],
                                borderWidth: 1
                            },
                            {
                                label: 'Simple Moving Average (SMA)',
                                data: sma_data.slice(-24),
                                backgroundColor: [
                                    'white',
                                ],
                                borderColor: [
                                    'white',
                                ],
                                borderWidth: 1
                            },
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                //beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                            position: 'top',
                            },
                            title: {
                            display: true,
                            text: graphTitle
                            }
                        }
                    }
                });

              }
        });
    });

    $('#submit-btn').click(function() {
        // when the user specifies a new ticker, we call the Django backend (the 'get_stock_data' function) to get the stock data and refresh the graph. 
        // obtain the ticker string from the input textbox
        var tickerText = $('#ticker-input').val();
        $.ajax({
              type: "POST",
              url: "/get_stock_data/",
              data: {
                 'ticker': tickerText,
              },
              success: function (res, status) {
                // stock price and SMA data for the user-specified ticker is now in the "res" object
                var tickerDisplay = res['prices']['Meta Data']['2. Symbol'];
                var graphTitle = tickerDisplay + ' (data for the trailing 500 trading days)'

                var priceSeries = res['prices']['Time Series (Daily)'];
                var daily_adjusted_close = [];
                var dates = [];

                price_data_parse = function(){
                    for (let key in priceSeries) {
                        daily_adjusted_close.push(Number(priceSeries[key]['5. adjusted close']));
                        dates.push(String(key));
                    }

                };
                price_data_parse();

                var smaSeries = res['sma']['Technical Analysis: SMA'];
                var sma_data = [];

                sma_data_parse = function(){
                    for (let key in smaSeries) {
                        sma_data.push(Number(smaSeries[key]['SMA']));
                    }

                };
                sma_data_parse();


                // only keep the latest 500 data points (i.e., data for the latest 500 trading days) for the three lists below
                daily_adjusted_close.reverse().slice(24);
                sma_data.reverse().slice(24);
                dates.reverse().slice(24);

                //instruct Chart.js to plot the graph, with "dates" as the x-axis labels and "daily_adjusted_close" and "sma_data" as the y-axis values
                $('#myChart').remove(); // this is my <canvas> element
                $('#graph-area').append('<canvas id="myChart"><canvas>');
                var ctx = document.getElementById('myChart').getContext('2d');
                var myChart = new Chart(ctx, {
                type: 'line',
                    data: {
                        labels: dates.slice(-24),
                        datasets: [
                            {
                                label: 'Daily Adjusted Close',
                                data: daily_adjusted_close.slice(-24),
                                backgroundColor: [
                                    'green',
                                ],
                                borderColor: [
                                    'green',
                                ],
                                borderWidth: 1
                            },
                            {
                                label: 'Simple Moving Average (SMA)',
                                data: sma_data.slice(-24),
                                backgroundColor: [
                                    'white',
                                ],
                                borderColor: [
                                    'white',
                                ],
                                borderWidth: 1
                            },
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                //beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                            position: 'top',
                            },
                            title: {
                            display: true,
                            text: graphTitle
                            }
                        }
                    }
                });

              }
              
        });


    });

</script>

<script>
    /*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Validação do formulário de pesquisa de ações
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/	

// Ticker da ação cujos dados quer consultar
var symbol = 'PETR4.SA';

function validar(){		
	var aux = document.getElementById('txtSymbol').value;
	symbol = aux;
	
	if (aux === undefined || aux ==null || aux.length<5) {
		document.getElementById('error').style.display = 'block';
		document.getElementById('error').innerHTML = 'Código de ação inválido!';
		document.getElementById('txtSymbol').focus();		
	}
	else {
		document.getElementById('error').style.display = 'none';
		lineChartData = [ ['',0,0] ];
		symbol = aux;
		urlDaily = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&interval=5min&apikey=${apiKey}`;		
		// Solicitando os dados para a API
		requestData(urlDaily);				
	}	
}


/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Programação do uso da API AlphaVantage
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/	

// Sua chave para acesso à API
var apiKey = '9H3L5CFY26CVAR3M';

// URL para solicitar dados de cotação diária de uma ação
var urlDaily = 
	`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&interval=5min&apikey=${apiKey}`;

// Variáveis globais para receber os dados utilizados pelos gráficos
var barChartData;
var lineChartData = [ [,,] ];

// Função para requisitar os ddos da API
async function requestData( url ) { 

	const options = {
		method: 'GET',
		mode: 'cors',
		cache: 'default'
	};
	
	await fetch( url, options )
		.then( response => { response.json() 
			.then ( data => showData(data) )
		})
		.catch ( e => showError(e.message) )
} 

// Função para informar possíveis erros
function showError(msg) {	
	document.getElementById('error').style.display = 'block';
	document.getElementById('error').innerHTML = 'Erro: ' + msg;
	document.getElementById('txtSymbol').focus();		
}

//	Função para exibição dos dados 
function showData(data) {
	
	let aux = data['Time Series (Daily)'];
	let rowsCount = 0;		
	let maxima = 0;
	let minima = 99999999;
	let media = 0;
	
	document.getElementById('series-table').tBodies[0].innerHTML = '';
		
	for ( const field in aux ) {	
		let auxDate = new Date(field);
		let day = ( (auxDate.getDate()+1) <10) ? ('0'+ (auxDate.getDate()+1) ) : (auxDate.getDate() + 1);
		let month = ( (auxDate.getMonth()+1) <10) ? ('0'+ (auxDate.getMonth()+1) ) : (auxDate.getMonth()+1);
		let year = auxDate.getFullYear();		
		let formatDate =  day + '/' + month + '/' + year;	
		
		let openValue = parseFloat(aux[field]['1. open']).toFixed(2);
		let closeValue = parseFloat(aux[field]['4. close']).toFixed(2);		
		
		// Adicionando os últimos 4 registros na tabela da página index
		if ( rowsCount < 5 ) {
			addTableContent(formatDate, openValue, closeValue);			
		}			
		
		if (maxima < parseFloat(aux[field]['4. close'])) {
			maxima = parseFloat(aux[field]['4. close']);
		}
		
		if (minima > parseFloat(aux[field]['4. close'])) {
			minima = parseFloat(aux[field]['4. close']);			
		}
		
		media += parseFloat(aux[field]['4. close']);		
		
		lineChartData[rowsCount] = [formatDate, 
			parseFloat(aux[field]['1. open']), 
			parseFloat(aux[field]['4. close'])
		];
		
		//lineChartData.push(auxValues );
		rowsCount++;
	} // for	
	
	media = media / rowsCount;
	
	if (minima == 99999999) { minima = 0; }
	
	// Informando valores para o gráfico de colunas
	barChartData = [ ['', maxima, media, minima] ];		
	google.charts.load('current', {packages: ['corechart', 'bar']});		
	google.charts.setOnLoadCallback(drawMultSeries);
	
	// Informando valores para o gráfico de linhas		
	google.charts.load('current', {packages: ['corechart', 'line']});		
	google.charts.setOnLoadCallback(drawCurveTypes);	
}

//	Função para adicionar dados à tabela da página index.html
function addTableContent(date, open, close){
	var myTable = document.getElementById('series-table').tBodies[0];	
	myTable.innerHTML = myTable.innerHTML + `<tr><td>${date}</td><td>${open}</td><td>${close}</td></tr>`;
}


/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Gráficos Google Charts para os valores recebidos via API
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/	

// Gráfico de colunas para valores de referência
function drawMultSeries() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Preço');
	data.addColumn('number', 'Máxima');
    data.addColumn('number', 'Média');
    data.addColumn('number', 'Mínima');

    data.addRows(barChartData);

    var options = {
        title: 'Referências de preço do ativo',
        hAxis: {
          title: 'Referência',
        },
        vAxis: {
          title: 'Valores'
        }
    };

    var chart = new google.visualization.ColumnChart( document.getElementById('chart-column') );
    chart.draw(data, options);
}


// Gráfico de linha para série diária de valores
function drawCurveTypes() {
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Data');
    data.addColumn('number', 'Abertura');
    data.addColumn('number', 'Fechamento');

    data.addRows(lineChartData.reverse());

    var options = {
		title: 'Série diária de preço do ativo',  
        hAxis: {
          title: 'Data'
        },
        vAxis: {
          title: 'Valores'
        },
        series: {
          1: {curveType: 'function'}
        }
    };

    var chart = new google.visualization.LineChart(document.getElementById('chart-line'));
    chart.draw(data, options);
}
	
</script>
</body>
<html>